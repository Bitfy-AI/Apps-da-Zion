name: 🎯 ZION Smart Builder - Main

on:
  schedule:
    - cron: '0 0,12 * * *'  # 2x ao dia
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Forçar build'
        required: false
        default: 'none'
        type: choice
        options:
          - 'none'
          - 'n8n'
          - 'directus'
          - 'all'
  push:
    branches: [main]
    paths:
      - 'n8n/**'
      - 'directus/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
    paths:
      - 'n8n/**'
      - 'directus/**'

permissions:
  contents: write
  packages: write

jobs:
  # 🔍 JOB 1: Detectar o que mudou
  detect-changes:
    name: 🔍 Detectar Mudanças
    runs-on: ubuntu-latest
    outputs:
      n8n_changed: ${{ steps.filter.outputs.n8n }}
      directus_changed: ${{ steps.filter.outputs.directus }}
      force_n8n: ${{ steps.force.outputs.n8n }}
      force_directus: ${{ steps.force.outputs.directus }}
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: 🔍 Detectar arquivos alterados
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            n8n:
              - 'n8n/**'
              - '.github/workflows/build-n8n.yml'
            directus:
              - 'directus/**'
              - '.github/workflows/build-directus.yml'
      
      - name: 🎯 Processar força de build
        id: force
        run: |
          if [[ "${{ github.event.inputs.force_build }}" == "all" ]] || [[ "${{ github.event.inputs.force_build }}" == "n8n" ]]; then
            echo "n8n=true" >> $GITHUB_OUTPUT
          else
            echo "n8n=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "${{ github.event.inputs.force_build }}" == "all" ]] || [[ "${{ github.event.inputs.force_build }}" == "directus" ]]; then
            echo "directus=true" >> $GITHUB_OUTPUT
          else
            echo "directus=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 📊 Resumo de mudanças
        run: |
          echo "### 📊 Resumo de Mudanças" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Serviço | Mudanças | Forçado | Ação |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|---------|------|" >> $GITHUB_STEP_SUMMARY
          
          N8N_ACTION="⏭️ Skip"
          if [[ "${{ steps.filter.outputs.n8n }}" == "true" ]] || [[ "${{ steps.force.outputs.n8n }}" == "true" ]]; then
            N8N_ACTION="✅ Build"
          fi
          
          DIRECTUS_ACTION="⏭️ Skip"
          if [[ "${{ steps.filter.outputs.directus }}" == "true" ]] || [[ "${{ steps.force.outputs.directus }}" == "true" ]]; then
            DIRECTUS_ACTION="✅ Build"
          fi
          
          echo "| **N8N** | ${{ steps.filter.outputs.n8n == 'true' && '✅' || '❌' }} | ${{ steps.force.outputs.n8n == 'true' && '✅' || '❌' }} | $N8N_ACTION |" >> $GITHUB_STEP_SUMMARY
          echo "| **Directus** | ${{ steps.filter.outputs.directus == 'true' && '✅' || '❌' }} | ${{ steps.force.outputs.directus == 'true' && '✅' || '❌' }} | $DIRECTUS_ACTION |" >> $GITHUB_STEP_SUMMARY

  # 🔨 JOB 2: Build N8N (condicional)
  build-n8n:
    name: 🔨 Build N8N
    needs: detect-changes
    if: needs.detect-changes.outputs.n8n_changed == 'true' || needs.detect-changes.outputs.force_n8n == 'true' || github.event_name == 'schedule'
    uses: ./.github/workflows/build-n8n.yml
    with:
      check_version: ${{ github.event_name == 'schedule' }}
    secrets: inherit

  # 🔨 JOB 3: Build Directus (condicional)
  build-directus:
    name: 🔨 Build Directus
    needs: detect-changes
    if: needs.detect-changes.outputs.directus_changed == 'true' || needs.detect-changes.outputs.force_directus == 'true' || github.event_name == 'schedule'
    uses: ./.github/workflows/build-directus.yml
    with:
      check_version: ${{ github.event_name == 'schedule' }}
    secrets: inherit

  # 📢 JOB 4: Notificação consolidada
  notify:
    name: 📢 Notificar Resultados
    runs-on: ubuntu-latest
    needs: [build-n8n, build-directus]
    if: always() && (needs.build-n8n.result == 'success' || needs.build-directus.result == 'success')
    
    steps:
      - name: 📊 Preparar mensagem
        id: message
        run: |
          MESSAGE="🚀 **ZION Build Completo**\n\n"
          
          if [[ "${{ needs.build-n8n.result }}" == "success" ]]; then
            MESSAGE="${MESSAGE}✅ N8N: Build concluído\n"
          elif [[ "${{ needs.build-n8n.result }}" == "skipped" ]]; then
            MESSAGE="${MESSAGE}⏭️ N8N: Sem mudanças\n"
          else
            MESSAGE="${MESSAGE}❌ N8N: Falhou\n"
          fi
          
          if [[ "${{ needs.build-directus.result }}" == "success" ]]; then
            MESSAGE="${MESSAGE}✅ Directus: Build concluído\n"
          elif [[ "${{ needs.build-directus.result }}" == "skipped" ]]; then
            MESSAGE="${MESSAGE}⏭️ Directus: Sem mudanças\n"
          else
            MESSAGE="${MESSAGE}❌ Directus: Falhou\n"
          fi
          
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: 📱 Telegram
        continue-on-error: true
        if: vars.TELEGRAM_TOKEN != ''
        env:
          TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d "chat_id=${CHAT}" \
            -d "text=${{ steps.message.outputs.message }}" \
            -d "parse_mode=Markdown"
