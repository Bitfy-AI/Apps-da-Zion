name: 📦 Build N8N

on:
  workflow_call:
    inputs:
      check_version:
        required: false
        type: boolean
        default: true

env:
  IMAGE_NAME: iazion/n8n
  SERVICE: n8n

jobs:
  check-and-build:
    name: N8N Build
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
      
      - name: 🔍 Verificar versão
        id: version
        if: inputs.check_version
        run: |
          echo "🔍 Verificando versão do N8N..."
          LATEST=$(curl -s https://api.github.com/repos/n8n-io/n8n/releases/latest | jq -r .tag_name)
          LATEST_CLEAN=${LATEST#n8n@}
          LATEST_CLEAN=${LATEST_CLEAN#v}
          
          # Verificar se já temos essa versão
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/${{ env.IMAGE_NAME }}/tags?page_size=100" | jq -r '.results[].name' || echo "")
          
          if echo "$TAGS" | grep -q "^${LATEST_CLEAN}$"; then
            echo "✅ Versão ${LATEST_CLEAN} já existe"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "🆕 Nova versão: ${LATEST_CLEAN}"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
          
          echo "version=${LATEST_CLEAN}" >> $GITHUB_OUTPUT
      
      - name: 🔧 Setup Docker Buildx
        if: steps.version.outputs.skip != 'true'
        uses: docker/setup-buildx-action@v3
      
      - name: 🔐 Login Docker Hub
        if: steps.version.outputs.skip != 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: 🚀 Build e Push
        if: steps.version.outputs.skip != 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./n8n
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=n8n
          cache-to: type=gha,scope=n8n,mode=max
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.run_id }}
