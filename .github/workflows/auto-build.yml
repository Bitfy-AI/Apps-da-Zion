# .github/workflows/auto-build.yml
# ============================================
# ZION N8N - Auto Builder Inteligente
# ============================================

name: ðŸš€ ZION N8N Smart Build

on:
  # Verifica 2x por dia se hÃ¡ atualizaÃ§Ãµes
  schedule:
    - cron: '0 0,12 * * *'
  
  # Build manual quando quiser
  workflow_dispatch:
    inputs:
      force_build:
        description: 'ForÃ§ar build mesmo sem atualizaÃ§Ã£o'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  
  # Build ao fazer push
  push:
    branches: [main]
    paths:
      - 'Dockerfile'
      - '.github/workflows/auto-build.yml'

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: zion/n8n

jobs:
  # JOB 1: Verificar se precisa build
  check-version:
    name: ðŸ” Verificar VersÃ£o
    runs-on: ubuntu-latest
    outputs:
      needs_build: ${{ steps.compare.outputs.needs_build }}
      n8n_version: ${{ steps.check.outputs.n8n_version }}
      n8n_version_clean: ${{ steps.check.outputs.n8n_version_clean }}
      build_date: ${{ steps.check.outputs.build_date }}
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ” Verificar versÃ£o do n8n oficial
        id: check
        run: |
          echo "ðŸ” Buscando Ãºltima versÃ£o do n8n..."
          
          # Pegar Ãºltima versÃ£o do n8n oficial
          N8N_VERSION=$(curl -s https://api.github.com/repos/n8n-io/n8n/releases/latest | jq -r .tag_name)
          N8N_VERSION_CLEAN=${N8N_VERSION#n8n@}  # Remove prefixo se houver
          N8N_VERSION_CLEAN=${N8N_VERSION_CLEAN#v}  # Remove v se houver
          
          echo "ðŸ“¦ VersÃ£o n8n oficial: $N8N_VERSION_CLEAN"
          
          # Salvar outputs
          echo "n8n_version=$N8N_VERSION" >> $GITHUB_OUTPUT
          echo "n8n_version_clean=$N8N_VERSION_CLEAN" >> $GITHUB_OUTPUT
          echo "build_date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
      
      - name: ðŸ·ï¸ Verificar nossa Ãºltima versÃ£o
        id: our_version
        run: |
          echo "ðŸ” Verificando nossa Ãºltima build..."
          
          # Verificar se nossa imagem existe e pegar tags
          DOCKER_TAGS=$(curl -s "https://hub.docker.com/v2/repositories/${{ env.IMAGE_NAME }}/tags?page_size=100" | jq -r '.results[].name' || echo "none")
          
          echo "ðŸ“‹ Nossas tags atuais:"
          echo "$DOCKER_TAGS" | head -5
          
          # Verificar se jÃ¡ temos essa versÃ£o
          if echo "$DOCKER_TAGS" | grep -q "^${{ steps.check.outputs.n8n_version_clean }}$"; then
            echo "âœ… VersÃ£o ${{ steps.check.outputs.n8n_version_clean }} jÃ¡ existe"
            echo "has_version=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ†• Nova versÃ£o detectada: ${{ steps.check.outputs.n8n_version_clean }}"
            echo "has_version=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ¤” Decidir se precisa build
        id: compare
        run: |
          echo "ðŸ“Š Analisando necessidade de build..."
          
          # Verificar condiÃ§Ãµes
          NEEDS_BUILD="false"
          REASON=""
          
          # 1. Se forÃ§ar build
          if [[ "${{ github.event.inputs.force_build }}" == "true" ]]; then
            NEEDS_BUILD="true"
            REASON="Build forÃ§ado manualmente"
          
          # 2. Se Ã© push no main com mudanÃ§as no Dockerfile
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            NEEDS_BUILD="true"
            REASON="AlteraÃ§Ãµes no Dockerfile"
          
          # 3. Se nÃ£o temos a versÃ£o ainda
          elif [[ "${{ steps.our_version.outputs.has_version }}" == "false" ]]; then
            NEEDS_BUILD="true"
            REASON="Nova versÃ£o do n8n: ${{ steps.check.outputs.n8n_version_clean }}"
          fi
          
          # Output
          echo "needs_build=$NEEDS_BUILD" >> $GITHUB_OUTPUT
          
          # Log
          if [[ "$NEEDS_BUILD" == "true" ]]; then
            echo "âœ… Build necessÃ¡rio: $REASON"
          else
            echo "â­ï¸ Build nÃ£o necessÃ¡rio - versÃ£o jÃ¡ estÃ¡ atualizada"
          fi

  # JOB 2: Build e Push (sÃ³ roda se precisar)
  build-and-push:
    name: ðŸ”¨ Build ZION N8N
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.needs_build == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64
      
      - name: ðŸ”§ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: latest
          driver-opts: network=host
      
      - name: ðŸ” Login Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: ðŸ“Š Preparar Metadata
        id: meta
        run: |
          echo "ðŸ·ï¸ Preparando tags..."
          
          VERSION="${{ needs.check-version.outputs.n8n_version_clean }}"
          DATE="${{ needs.check-version.outputs.build_date }}"
          
          # Criar lista de tags
          TAGS="${{ env.IMAGE_NAME }}:latest"
          TAGS="$TAGS,${{ env.IMAGE_NAME }}:$VERSION"
          TAGS="$TAGS,${{ env.IMAGE_NAME }}:$VERSION-$DATE"
          
          # Se for stable release (nÃ£o tem - no nome)
          if [[ ! "$VERSION" =~ "-" ]]; then
            TAGS="$TAGS,${{ env.IMAGE_NAME }}:stable"
          fi
          
          echo "ðŸ“ Tags que serÃ£o criadas:"
          echo "$TAGS" | tr ',' '\n'
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
      
      - name: ðŸš€ Build e Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            N8N_VERSION=${{ needs.check-version.outputs.n8n_version_clean }}
            BUILD_DATE=${{ needs.check-version.outputs.build_date }}
            VCS_REF=${{ github.sha }}
          labels: |
            org.opencontainers.image.title=ZION N8N
            org.opencontainers.image.description=n8n com ferramentas extras da comunidade ZION
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.version=${{ needs.check-version.outputs.n8n_version_clean }}
            org.opencontainers.image.created=${{ needs.check-version.outputs.build_date }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.vendor=ZION Community
      
      - name: ðŸ“ Criar Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << EOF
          ## ðŸš€ ZION N8N v${{ needs.check-version.outputs.n8n_version_clean }}
          
          ### ðŸ“¦ VersÃ£o do n8n
          - n8n oficial: **${{ needs.check-version.outputs.n8n_version_clean }}**
          - Build: **${{ needs.check-version.outputs.build_date }}**
          
          ### ðŸ³ Como usar
          \`\`\`bash
          # Pull da nova versÃ£o
          docker pull ${{ env.IMAGE_NAME }}:latest
          
          # Ou versÃ£o especÃ­fica
          docker pull ${{ env.IMAGE_NAME }}:${{ needs.check-version.outputs.n8n_version_clean }}
          
          # Rodar
          docker run -d -p 5678:5678 ${{ env.IMAGE_NAME }}:latest
          \`\`\`
          
          ### ðŸ”„ Para atualizar instalaÃ§Ã£o existente
          \`\`\`bash
          docker-compose pull
          docker-compose up -d
          \`\`\`
          
          ### âœ¨ O que estÃ¡ incluÃ­do
          - âœ… n8n v${{ needs.check-version.outputs.n8n_version_clean }}
          - âœ… Python 3 + bibliotecas (pandas, requests, beautifulsoup4, openai)
          - âœ… Git, FFmpeg, ImageMagick
          - âœ… Timezone Brasil configurado
          - âœ… Multi-arquitetura (amd64, arm64)
          
          ---
          ðŸ’¬ [Comunidade ZION](https://t.me/zioncommunity) | ðŸ“š [DocumentaÃ§Ã£o](https://github.com/${{ github.repository }})
          EOF

  # JOB 3: Notificar comunidade (sÃ³ se teve build)
  notify:
    name: ðŸ“¢ Notificar Comunidade
    runs-on: ubuntu-latest
    needs: [check-version, build-and-push]
    if: always() && needs.build-and-push.result == 'success'
    
    steps:
      - name: ðŸ“± Notificar Telegram
        if: secrets.TELEGRAM_TOKEN != ''
        continue-on-error: true
        run: |
          MESSAGE="ðŸš€ *Nova versÃ£o ZION/N8N disponÃ­vel!*
          
          ðŸ“¦ VersÃ£o: \`${{ needs.check-version.outputs.n8n_version_clean }}\`
          ðŸ“… Data: ${{ needs.check-version.outputs.build_date }}
          
          ðŸ³ Para atualizar:
          \`\`\`
          docker pull zion/n8n:latest
          docker-compose up -d
          \`\`\`
          
          ðŸ“š [Ver Release](https://github.com/${{ github.repository }}/releases)"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true"
      
      - name: ðŸ’¬ Notificar Discord
        if: secrets.DISCORD_WEBHOOK != ''
        continue-on-error: true
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{
              "embeds": [{
                "title": "ðŸš€ Nova versÃ£o ZION/N8N disponÃ­vel!",
                "description": "VersÃ£o **${{ needs.check-version.outputs.n8n_version_clean }}** estÃ¡ pronta para uso!",
                "color": 5814783,
                "fields": [
                  {
                    "name": "ðŸ“¦ VersÃ£o",
                    "value": "`${{ needs.check-version.outputs.n8n_version_clean }}`",
                    "inline": true
                  },
                  {
                    "name": "ðŸ“… Build",
                    "value": "${{ needs.check-version.outputs.build_date }}",
                    "inline": true
                  },
                  {
                    "name": "ðŸ³ Como atualizar",
                    "value": "```bash\ndocker pull zion/n8n:latest```"
                  }
                ],
                "footer": {
                  "text": "ZION Community"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }' \
            ${{ secrets.DISCORD_WEBHOOK }}
      
      - name: ðŸ·ï¸ Criar Release no GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version.outputs.n8n_version_clean }}
          name: ZION N8N v${{ needs.check-version.outputs.n8n_version_clean }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # JOB 4: Log quando nÃ£o precisar build
  skip-build:
    name: â­ï¸ Build NÃ£o NecessÃ¡rio
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.needs_build == 'false'
    
    steps:
      - name: ðŸ“ Log
        run: |
          echo "â­ï¸ Build pulado - jÃ¡ temos a versÃ£o ${{ needs.check-version.outputs.n8n_version_clean }}"
          echo ""
          echo "ðŸ“Š Status:"
          echo "- n8n oficial: ${{ needs.check-version.outputs.n8n_version_clean }}"
          echo "- Nossa imagem: zion/n8n:${{ needs.check-version.outputs.n8n_version_clean }} âœ…"
          echo "- PrÃ³xima verificaÃ§Ã£o: em 12 horas"
          echo ""
          echo "ðŸ’¡ Para forÃ§ar build, use o workflow_dispatch com force_build=true"
